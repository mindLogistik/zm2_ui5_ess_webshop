sap.ui.define(["sap/ui/core/UIComponent","./model/IndexedDBModel","./model/models","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel"],function(t,e,n,r,s,o){"use strict";return t.extend("diehlwebshop.Component",{metadata:{manifest:"json",interfaces:["sap.ui.core.IAsyncContentCreation"]},init:function(){if(!window.name||!window.name.startsWith("WEBSHOP_MAIN_")){let t=localStorage.getItem("WEBSHOP_MAIN_ID");if(!t){t=String(Date.now())+"_"+Math.random().toString(16).slice(2);localStorage.setItem("WEBSHOP_MAIN_ID",t)}window.name="WEBSHOP_MAIN_"+t}const r=sap.ui.getCore().getConfiguration().getLanguage();const i=new o({bundleName:"diehlwebshop.i18n.i18n",bundleLocale:r});this.setModel(i,"i18n");this.setModel(new s({delay:0,layout:"TwoColumnsMidExpanded",cartOpen:false}),"appView");const a=new e("SHOPPING_CART",{cartEntries:[],savedForLaterEntries:[],totalPrice:0,showProceedButton:false,showEditButton:false});a.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.setModel(a,"cartProducts");const c=a.getProperty("/cartEntries");if(c&&!Array.isArray(c)){a.setProperty("/cartEntries",Object.values(c))}const l=a.getProperty("/savedForLaterEntries");if(l&&!Array.isArray(l)){a.setProperty("/savedForLaterEntries",Object.values(l))}this.setModel(new e("PRODUCT_COMPARISON",{category:"",item1:"",item2:""}),"comparison");const m=new sap.ui.model.json.JSONModel([]);this.setModel(m,"ociCatalogs");(function(){const t=this.getModel("i18n").getResourceBundle();const e=m.getData();const n=Array.isArray(e)?e.slice():[];if(!n.some(t=>t&&t.type==="FREETEXT")){n.unshift({type:"FREETEXT",katalogName:t.getText("freitextOpenDialogButtonText")});m.setData(n)}}).bind(this)();this.setModel(n.createDeviceModel(),"device");t.prototype.init.apply(this,arguments);const d=this._getOciRawParam();const u=!!d;if(u){this._forceHomeHash()}this.getRouter().initialize();if(u){setTimeout(function(){console.log("OCI DEBUG starting delayed import");const t=this._importOciFromUrlIfPresent();console.log("OCI DEBUG delayed import result:",t);console.log("OCI DEBUG cartEntries now:",this.getModel("cartProducts").getProperty("/cartEntries"))}.bind(this),300)}this.getRouter().attachTitleChanged(function(t){document.title=t.getParameter("title")||document.title})},_importOciFromRaw:function(t){try{const e=JSON.parse(decodeURIComponent(t));const n=Array.isArray(e)?e:e.items||[];if(Array.isArray(n)&&n.length>0){this._mergeItemsIntoCart(n)}}catch(t){console.warn("OCI: Konnte Payload nicht parsen",t)}},_mergeItemsIntoCart:function(t,e){const n=this.getModel("cartProducts");if(!n){return}const r=n.getProperty("/cartEntries");let s=Array.isArray(r)?r.slice():Object.values(r||{});if(!Array.isArray(s)){s=[]}t.forEach(t=>{const n=this._normalizeIncomingItem(t,e);if(!n){return}const r=s.findIndex(t=>String(t.ZmmWebsArtikelId)===String(n.ZmmWebsArtikelId));if(r>-1){const t=parseInt(s[r].MENGE,10)||0;s[r].MENGE=t+n.MENGE;s[r].Quantity=s[r].MENGE;s[r].ZmmWebsArtBez=s[r].ZmmWebsArtBez||n.ZmmWebsArtBez;s[r].Wlief=s[r].Wlief||n.Wlief;s[r].Meins=s[r].Meins||n.Meins;s[r].Waers=s[r].Waers||n.Waers;if(s[r].Bapre===undefined||s[r].Bapre===null){s[r].Bapre=n.Bapre}}else{s.push(n)}});n.setProperty("/cartEntries",s);if(typeof n.updateBindings==="function"){n.updateBindings(true)}n.refresh(true);const o=s.length>0;n.setProperty("/showProceedButton",o);n.setProperty("/showEditButton",o);n.refresh(true)},_hasOciParam:function(){if(new URLSearchParams(window.location.search).has("oci")){return true}const t=String(window.location.hash||"");const e=t.indexOf("?");if(e>=0){return new URLSearchParams(t.slice(e+1)).has("oci")}return false},_forceHomeHash:function(){try{const t=new URL(window.location.href);t.hash="#/";window.history.replaceState({},document.title,t.toString())}catch(t){console.warn("OCI: Konnte Hash nicht auf home setzen",t)}},_normalizeIncomingItem:function(t){const e=String(t.ZmmWebsArtikelId||t.Produktid||t.ProductId||t.id||"").trim();if(!e){return null}const n=Math.max(1,parseInt(t.MENGE??t.Quantity??t.qty??1,10)||1);const r=Number(t.Bapre??t.price??0);const s=String(t.Meins||t.Mengeneinheit||t.unit||"ST").trim();const o=s.toUpperCase();const i={PCE:"ST",PC:"ST",PCS:"ST",EA:"ST",ST:"ST"};const a=i[o]||s;const c=String(t.Waers||t.Currency||t.curr||"EUR").trim();const l=String(t.Lifnr||t.LIFNR||t.SupplierId||t.SUPPLIER_ID||t.vendorNo||t.VENDOR_NO||"").trim();let m="";if(!l){try{const t=sessionStorage.getItem("OCI_LAST_CTX");if(t){const e=JSON.parse(t);m=String(e&&e.lifnr?e.lifnr:"").trim()}}catch(t){m=""}}const d=l||m;const u=String(t.Wlief||t.Lieferant||t.manuf||t.Manufacturer||"").trim();const h={ZmmWebsArtikelId:e,ZmmWebsKatId:String(t.ZmmWebsKatId||t.Kategorieid||"OCI").trim(),ZmmWebsKatBez:String(t.ZmmWebsKatBez||"").trim(),ZmmWebsArtBez:String(t.ZmmWebsArtBez||t.Artikelbezeichnung||t.desc||e).trim(),Wlief:d||"",WliefText:u,Meins:a,Waers:c,Bapre:isNaN(r)?0:r,MENGE:n,Quantity:n};return h},_importOciFromUrlIfPresent:function(){console.log("OCI DEBUG import function entered");const t=this._getOciPayloadFromUrl();console.log("OCI DEBUG payload:",t);if(!t){return false}let e="";try{e=String(sessionStorage.getItem("OCI_LAST_LIFNR")||"").trim()}catch(t){e=""}console.log("OCI DEBUG default Wlief (LIFNR) from session:",e||"(leer)");const n=Array.isArray(t)?t:t.items||[];if(!Array.isArray(n)||n.length===0){this._cleanupOciParamInUrl();return true}this._mergeItemsIntoCart(n,e);console.log("OCI DEBUG imported items:",n.length);console.log("OCI DEBUG cartEntries after import:",this.getModel("cartProducts").getProperty("/cartEntries"));this._cleanupOciParamInUrl();try{sessionStorage.removeItem("OCI_LAST_LIFNR");sessionStorage.removeItem("OCI_LAST_CATALOG_ID");sessionStorage.removeItem("OCI_LAST_TS")}catch(t){}return true},_getOciRawParam:function(){try{const t=new URL(window.location.href);const e=t.searchParams.get("oci");if(e){return e}const n=t.hash||"";const r=n.split("?")[1]||"";const s=new URLSearchParams(r);const o=s.get("oci");return o||null}catch(t){console.warn("OCI: Konnte oci Parameter nicht lesen",t);return null}},_getOciPayloadFromUrl:function(){try{const t=new URL(window.location.href);const e=t.searchParams.get("oci");if(!e){return null}return JSON.parse(e)}catch(t){console.warn("OCI: Konnte URL-Payload nicht lesen/parsen",t);return null}},_cleanupOciParamInUrl:function(){try{const t=new URL(window.location.href);if(t.searchParams.has("oci")){t.searchParams.delete("oci")}if(t.hash&&t.hash.indexOf("?")>-1){const e=t.hash.split("?");const n=e[0];const r=e[1]||"";const s=new URLSearchParams(r);if(s.has("oci")){s.delete("oci");const e=s.toString();t.hash=e?n+"?"+e:n}}window.history.replaceState({},document.title,t.toString())}catch(t){console.warn("OCI: Konnte URL nicht bereinigen",t)}},getContentDensityClass:function(){if(this._sContentDensityClass===undefined){if(document.body.classList.contains("sapUiSizeCozy")||document.body.classList.contains("sapUiSizeCompact")){this._sContentDensityClass=""}else if(!r.support.touch){this._sContentDensityClass="sapUiSizeCompact"}else{this._sContentDensityClass="sapUiSizeCozy"}}return this._sContentDensityClass}})});
//# sourceMappingURL=Component.js.map