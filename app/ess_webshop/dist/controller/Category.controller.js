sap.ui.define(["./BaseController","../model/formatter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/core/Fragment"],(t,e,o,i,r,s,n)=>{"use strict";return t.extend("diehlwebshop.controller.Category",{formatter:e,_iLowFilterPreviousValue:0,_iHighFilterPreviousValue:5e3,onInit:function(){var t=new s({Suppliers:[]});this.getView().setModel(t,"view");var e=this.getOwnerComponent();this._oRouter=e.getRouter();this._oRouter.getRoute("category").attachMatched(this._loadCategories,this);this._oRouter.getRoute("product").attachMatched(this._loadCategories,this);this._oRouter.getRoute("productCart").attachMatched(this._loadCategories,this);this._oRouter.getRoute("category").attachMatched(function(){console.log("ROUTE MATCHED: category")},this);var o=this.byId("bildUrlCategoryPage");if(o){this._oProductTemplate=o.clone()}else{console.error("Template-Element 'bildUrlCategoryPage' nicht gefunden!")}},onCategorySearch:function(t){const e=t.getSource().getValue().toLowerCase();const o=this.byId("productListCategory");const i=o.getItems();i.forEach(t=>{const o=t.getBindingContext();if(o){const i=o.getObject();const r=(i.ZmmWebsArtBez||"").toLowerCase();const s=(i.Wlief||"").toLowerCase();const n=r.includes(e)||s.includes(e);t.setVisible(n)}})},_loadCategories:function(t){const e=this.getOwnerComponent().getModel("appView");const o=this.getModel();const i=this.byId("productListCategory");const r=t.getParameter("arguments").id;this._sProductId=t.getParameter("arguments").productId||null;this._updateCategoryTitle(r);this._loadSuppliers();const s=!!(e&&e.getProperty("/cartOpen"));if(e){e.setProperty("/layout",s?"ThreeColumnsMidExpanded":"TwoColumnsMidExpanded")}const n=this._sLastCategoryId;const a=n&&String(n)===String(r);const l=i&&i.getBinding("items");if(a&&l){if(this._sProductId&&i){const t=i.getItems();t.some(function(t){const e=t.getBindingContext();const o=e&&e.getProperty("ZmmWebsArtikelId")===this._sProductId;if(o){i.setSelectedItem(t)}return o}.bind(this))}return}this._sLastCategoryId=r;if(i){i.unbindItems();i.setBusy(true)}o.metadataLoaded().then(function(){if(!this._oProductTemplate){jQuery.sap.log.error("Kein gespeichertes Template vorhanden!");i.setBusy(false);return}const t=e=>{o.detachRequestSent(t);const i=e.getParameters&&e.getParameters()};o.attachRequestSent(t);i.bindItems({path:"/ArtikelSet",filters:[new sap.ui.model.Filter("ZmmWebsKatId",sap.ui.model.FilterOperator.EQ,r)],parameters:{operationMode:"Server"},template:this._oProductTemplate.clone(),templateShareable:false});const e=i.getBinding("items");if(e){e.attachDataReceived(function(){i.setBusy(false);const t=i.getItems().map(t=>{const e=t.getBindingContext()?.getObject();return{id:e?.ZmmWebsArtikelId,docId:e?.ZmmWebsDocId}});console.table(t);if(this._sProductId){const t=i.getItems();t.some(function(t){const e=t.getBindingContext();const o=e&&e.getProperty("ZmmWebsArtikelId")===this._sProductId;if(o){i.setSelectedItem(t)}return o}.bind(this))}}.bind(this))}else{i.setBusy(false)}}.bind(this))},_loadSuppliers:function(){var t=this.getModel();t.read("/ArtikelSet",{success:function(t){var e=t&&t.results||[];var o=e.map(function(t){return(t.Lieferant||t.Wlief||"").trim()}).filter(Boolean);var i=Array.from(new Set(o)).sort(function(t,e){return t.localeCompare(e,"de")});var r=i.map(function(t){return{Lieferant:t,SupplierName:t}});this.getModel("view").setProperty("/Suppliers",r)}.bind(this),error:function(t){jQuery.sap.log.error("Lieferanten konnten nicht geladen werden",t,"diehlwebshop.controller.Category");this.getModel("view").setProperty("/Suppliers",[])}.bind(this)});if(this._clearComparison){this._clearComparison()}},onProductListSelect:function(t){var e=this.byId("productListCategory");var o=e.getItems();o.some(function(t){if(t.getBindingContext().getPath()==="/ArtikelSet('"+this._sProductId+"')"){e.setSelectedItem(t);return true}}.bind(this))},onProductListSelect:function(t){this._showProduct(t)},onProductDetails:function(t){const e=t.getParameter("listItem")||t.getSource();const o=e&&e.getBindingContext();if(!o){return}const i=o.getObject();const r=String(i.ZmmWebsKatId);const s=String(i.ZmmWebsArtikelId);const n=this.getOwnerComponent().getModel("appView");const a=n&&(n.getProperty("/layout")||"").startsWith("Three");if(n){const t=!!n.getProperty("/cartOpen");n.setProperty("/layout",t?"ThreeColumnsMidExpanded":"TwoColumnsMidExpanded")}this._oRouter.navTo(a?"productCart":"product",{id:r,productId:s},!sap.ui.Device.system.phone)},_applyFilter:function(t){var e=this.byId("productListCategory"),o=e.getBinding("items"),s=t.getParameter("filterItems"),n=this.byId("categoryFilterDialog").getFilterItems()[1],a,l={},g=[],u=[],c=[],d=[];if(n.getCustomControl().getAggregation("content")[0].getValue()!==n.getCustomControl().getAggregation("content")[0].getMin()||n.getCustomControl().getAggregation("content")[0].getValue2()!==n.getCustomControl().getAggregation("content")[0].getMax()){s.push(n)}s.forEach(function(t){var e=t.getProperty("key"),o,s;switch(e){case"Available":a=new i("STATUS",r.EQ,"A");u.push(a);break;case"OutOfStock":a=new i("STATUS",r.EQ,"O");u.push(a);break;case"Discontinued":a=new i("STATUS",r.EQ,"D");u.push(a);break;case"Price":o=t.getCustomControl().getAggregation("content")[0].getValue();s=t.getCustomControl().getAggregation("content")[0].getValue2();a=new i("Bapre",r.BT,o,s);c.push(a);l["priceKey"]={Price:true};break;default:a=new i("Wlief",r.EQ,e);d.push(a)}});if(u.length>0){g.push(new i({filters:u}))}if(c.length>0){g.push(new i({filters:c}))}if(d.length>0){g.push(new i({filters:d}))}a=new i({filters:g,and:true});if(g.length>0){o.filter(a);this.byId("categoryInfoToolbar").setVisible(true);var h=this.getResourceBundle().getText("filterByText")+" ";var m="";var p=t.getParameter("filterCompoundKeys");var f=Object.assign(p,l);for(var y in f){if(f.hasOwnProperty(y)){h=h+m+this.getResourceBundle().getText(y,[this._iLowFilterPreviousValue,this._iHighFilterPreviousValue]);m=", "}}this.byId("categoryInfoToolbarTitle").setText(h)}else{o.filter(null);this.byId("categoryInfoToolbar").setVisible(false);this.byId("categoryInfoToolbarTitle").setText("")}},onFilter:function(){if(!this._pCategoryFilterDialog){this._pCategoryFilterDialog=n.load({id:this.getView().getId(),name:"sap.ui.demo.cart.view.CategoryFilterDialog",controller:this}).then(function(t){this.getView().addDependent(t);t.addStyleClass(this.getOwnerComponent().getContentDensityClass());return t}.bind(this))}this._pCategoryFilterDialog.then(function(t){t.open()})},handleConfirm:function(t){var e=this.byId("categoryFilterDialog").getFilterItems()[1];var o=e.getCustomControl().getAggregation("content")[0];this._iLowFilterPreviousValue=o.getValue();this._iHighFilterPreviousValue=o.getValue2();this._applyFilter(t)},handleCancel:function(){var t=this.byId("categoryFilterDialog").getFilterItems()[1];var e=t.getCustomControl().getAggregation("content")[0];e.setValue(this._iLowFilterPreviousValue).setValue2(this._iHighFilterPreviousValue);if(this._iLowFilterPreviousValue>e.getMin()||this._iHighFilterPreviousValue!==e.getMax()){t.setFilterCount(1)}else{t.setFilterCount(0)}},handleChange:function(t){var e=this.byId("categoryFilterDialog").getFilterItems()[1];var o=e.getCustomControl().getAggregation("content")[0];var i=t.getParameter("range")[0];var r=t.getParameter("range")[1];if(i!==o.getMin()||r!==o.getMax()){e.setFilterCount(1)}else{e.setFilterCount(0)}},handleResetFilters:function(){var t=this.byId("categoryFilterDialog").getFilterItems()[1];var e=t.getCustomControl().getAggregation("content")[0];e.setValue(e.getMin());e.setValue2(e.getMax());t.setFilterCount(0)},compareProducts:function(t){var e=t.getSource().getBindingContext().getObject();var o=this.getModel("comparison").getProperty("/item1");var i=this.getModel("comparison").getProperty("/item2");this._oRouter.navTo("comparison",{id:e.Category,item1Id:o?o:e.ProductId,item2Id:o&&o!=e.ProductId?e.ProductId:i},true)},_updateCategoryTitle:function(t){const e=this.getModel();this.getModel("view").setProperty("/categoryTitle","");const o="/"+e.createKey("KatalogSet",{ZmmWebsKatId:String(t||"").trim()});e.read(o,{urlParameters:{$select:"ZmmWebsKatBez"},success:function(t){const e=t&&t.ZmmWebsKatBez?String(t.ZmmWebsKatBez):"";this.getModel("view").setProperty("/categoryTitle",e)}.bind(this),error:function(){this.getModel("view").setProperty("/categoryTitle",this.getResourceBundle().getText("Category_title"))}.bind(this)})},onBack:function(){this.getRouter().navTo("categories")}})});
//# sourceMappingURL=Category.controller.js.map