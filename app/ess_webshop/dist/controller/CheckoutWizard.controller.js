sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast","sap/m/SelectDialog","sap/m/StandardListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator","../model/formatter","../model/IndexedDBModel","sap/ui/core/Item"],function(e,t,r,n,s,i,o,a,c,l,u){"use strict";const d="checkoutWizard";const g="checkout";const h="cartProducts";return e.extend("diehlwebshop.controller.CheckoutWizard",{formatter:c,onInit:function(){const e=new t({currentStep:"stepHead",validate:false});e.setDefaultBindingMode("TwoWay");this.getView().setModel(e,d);let r=this.getView().getModel(g);if(!r){r=new t(this._createCheckoutDefaults());r.setDefaultBindingMode("TwoWay");this.getView().setModel(r,g);this.getOwnerComponent().setModel(r,g)}r.setDefaultBindingMode("TwoWay");this._ensureCartItemExtensions();this._prefillReceiversWithCurrentUser();const n=this.byId("checkoutWizard");if(n){n.attachStepActivate(this._onStepActivate,this)}this._hookInvArtNoneItem();var s=this.byId("infoPopover");if(s){this.getView().addDependent(s)}const i=new sap.ui.model.json.JSONModel({text1:"",text2:""});this.getView().setModel(i,"info");const o=this.getOwnerComponent().getModel("appView");if(o){o.setProperty("/layout","OneColumn");o.setProperty("/cartOpen",false)}this.getRouter().getRoute("checkoutWizard").attachPatternMatched(this._onRouteMatchedCheckout,this)},_hookInvArtNoneItem:function(){const e=this.byId("cbInvArt");if(!e){return}const t=e.getBinding("items");if(!t){jQuery.sap.delayedCall(0,this,this._hookInvArtNoneItem);return}if(!this._fnEnsureInvArtNoneItem){this._fnEnsureInvArtNoneItem=this._ensureInvArtNoneItem.bind(this)}else{t.detachChange(this._fnEnsureInvArtNoneItem);if(t.detachDataReceived){t.detachDataReceived(this._fnEnsureInvArtNoneItem)}}t.attachChange(this._fnEnsureInvArtNoneItem);if(t.attachDataReceived){t.attachDataReceived(this._fnEnsureInvArtNoneItem)}this._ensureInvArtNoneItem()},_ensureInvArtNoneItem:function(){const e=this.byId("cbInvArt");if(!e){return}const t=e.getItems().some(function(e){return e&&e.getKey&&e.getKey()==="NONE"});if(!t){e.insertItem(new u({key:"NONE",text:this.getResourceBundle().getText("cw.invArt.none")}),0)}const r=this.getView().getModel("checkout");const n=r&&r.getProperty("/head/invArt");if(n==="NONE"){e.setSelectedKey("NONE")}},_syncHeadAccountToCartItems:function(){const e=this.getView().getModel("checkout");const t=this.getView().getModel("cartProducts");if(!e||!t){return}const r=e.getProperty("/head")||{};if(Number(r.materialTypeIndex)!==0){return}const n=this._getCartEntries()||[];if(n.length<2){return}const s=n[0]||{};const i=(s.accountType||"").trim();if(!i){return}n.forEach((e,r)=>{if(r===0){return}if(!(e.accountType||"").trim()){t.setProperty("/cartEntries/"+r+"/accountType",i)}if(i==="gl"){if(!(e.costCenter||"").trim()&&(s.costCenter||"").trim()){t.setProperty("/cartEntries/"+r+"/costCenter",s.costCenter)}t.setProperty("/cartEntries/"+r+"/internalOrder","");t.setProperty("/cartEntries/"+r+"/accountValue","");if(!(e.glAccount||"").trim()&&(s.glAccount||"").trim()){t.setProperty("/cartEntries/"+r+"/glAccount",s.glAccount)}}else if(i==="io"){if(!(e.internalOrder||"").trim()&&(s.internalOrder||"").trim()){t.setProperty("/cartEntries/"+r+"/internalOrder",s.internalOrder)}t.setProperty("/cartEntries/"+r+"/costCenter","");t.setProperty("/cartEntries/"+r+"/accountValue","")}else if(i==="wbs"){if(!(e.accountValue||"").trim()&&(s.accountValue||"").trim()){t.setProperty("/cartEntries/"+r+"/accountValue",s.accountValue)}t.setProperty("/cartEntries/"+r+"/costCenter","");t.setProperty("/cartEntries/"+r+"/internalOrder","")}});t.refresh(true)},_onRouteMatchedCheckout:function(){const e=this.getView().getModel(d);if(e){e.setProperty("/validate",false);e.setProperty("/currentStep","stepHead")}const t=this.byId("checkoutWizard");const r=this.byId("stepHead");const n=this.byId("stepCart");if(t&&r&&n){if(t.discardProgress){t.discardProgress(n)}t.goToStep(r)}this._prefillReceiversWithCurrentUser()},onReturnToShop:function(){const e=this.getView().getModel("checkoutWizard");if(e){e.setProperty("/validate",false);e.setProperty("/currentStep","stepHead")}const t=this.byId("checkoutWizard");const r=this.byId("stepCart");if(t&&r){if(t.discardProgress){t.discardProgress(r)}t.goToStep(r)}const n=this.getOwnerComponent().getModel("appView");if(n){n.setProperty("/cartOpen",false);n.setProperty("/layout","TwoColumnsMidExpanded")}this.getRouter().navTo("purchaseRequests",{},true)},_genBanfnId:function(){const e=(new Date).toISOString().slice(2,10).replace(/-/g,"");const t=Math.floor(1e3+Math.random()*9e3);return e+t},_persistMockBanfn:async function(e){const t="mock_banfen";try{let r=await IDB.getItem(t);if(!Array.isArray(r)){r=[]}r.push(e);await IDB.setItem(t,r)}catch(r){try{let r=[];try{r=JSON.parse(localStorage.getItem(t)||"[]")}catch(e){}r.push(e);localStorage.setItem(t,JSON.stringify(r))}catch(e){}}const r=this.getView().getModel("checkout");r.setProperty("/lastBanfn",e)},onInfoPress:function(e){const t=e.getSource();let r="";const n=t.getCustomData?t.getCustomData():[];const s=n&&n.find(e=>e.getKey&&e.getKey()==="cwInfoKey");r=s&&s.getValue?s.getValue():"";if(!r){return}const i=this.getResourceBundle();const o=this.getView().getModel("info");const a=i.getText("cw.info."+r+".text1");let c="";try{c=i.getText("cw.info."+r+".text2");if(c==="cw.info."+r+".text2"){c=""}}catch(e){c=""}o.setProperty("/text1",a);o.setProperty("/text2",c);const l=this.byId("infoPopover");if(!l){return}l.openBy(t)},onContinueFromCart:function(){const e=this.getResourceBundle();this.getView().getModel("checkoutWizard").setProperty("/validate",true);const t=this.byId("checkoutWizard");const r=this.byId("stepCart");const n=this._checkCartRequired();if(!n.ok){if(t&&r){t.invalidateStep(r)}sap.m.MessageBox.information(e.getText("cw.msg.correctFields")+"\n• "+n.missing.join("\n• "));return}if(t&&r){t.validateStep(r);this.getView().getModel("checkoutWizard").setProperty("/currentStep","stepForm");sap.ui.getCore().applyChanges();t.nextStep()}},onContinueFromHead:function(){if(!this._validateStepAccounting()){return}const e=this.byId("checkoutWizard");const t=this.byId("stepHead");if(e&&t){e.validateStep(t);this.getView().getModel("checkoutWizard").setProperty("/currentStep","stepForm");sap.ui.getCore().applyChanges();e.nextStep()}},onContinueFromForm:function(){if(!this._validateStepForm()){return}const e=this.byId("checkoutWizard");const t=this.byId("stepForm");if(e&&t){e.validateStep(t);this._applyDesiredDateDefault();this.getView().getModel("checkoutWizard").setProperty("/currentStep","stepCart");sap.ui.getCore().applyChanges();e.nextStep()}},onSubmitOrder:function(){const e=this.getResourceBundle();if(!this._validateStepAccounting()){const e=this.byId("checkoutWizard");if(e&&this.byId("stepHead")){e.goToStep(this.byId("stepHead"))}return}this._syncHeadAccountToCartItems();const t=this._checkCartRequired();if(!t.ok){sap.m.MessageBox.information(e.getText("cw.msg.correctFields")+"\n• "+t.missing.join("\n• "));const r=this.byId("checkoutWizard");if(r&&this.byId("stepCart")){r.goToStep(this.byId("stepCart"))}return}const r=this.getOwnerComponent().getModel();const n=this._buildDeepCreatePayload();const s=this.getView().getModel("checkout");const i=s&&s.getProperty("/head")||{};const o=Array.isArray(n&&n.NavTo_TextLine)?n.NavTo_TextLine:[];const a=o.filter(e=>String(e.Tdid)==="B03");const c=a.map(e=>String(e.Tdline||"")).join("\n");sap.m.MessageBox.confirm(e.getText("cw.msg.submitConfirm"),{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(t){if(t!==sap.m.MessageBox.Action.OK){return}sap.ui.core.BusyIndicator.show(0);r.create("/BestellanforderungSet",n,{groupId:"$direct",success:async function(t){sap.ui.core.BusyIndicator.hide();const r=t&&(t.Banfn||t.BANFN||t.banfn)?String(t.Banfn||t.BANFN||t.banfn):"";const n=this.getView().getModel("checkout");if(n){n.setProperty("/banfn",r);n.refresh(true)}try{sap.ui.core.BusyIndicator.show(0);await this._uploadAllAttachmentsForBanfn(r)}finally{sap.ui.core.BusyIndicator.hide()}const s=this.getView().getModel("cartProducts");if(s){s.setProperty("/cartEntries",[]);s.setProperty("/savedForLaterEntries",[]);s.refresh(true)}sap.m.MessageBox.success(e.getText("cw.msg.submitSuccess",[r]),{onClose:function(){this.getRouter().navTo("purchaseRequests")}.bind(this)})}.bind(this),error:function(t){sap.ui.core.BusyIndicator.hide();let r=e.getText("cw.msg.submitErrorDefault");try{const e=JSON.parse(t.responseText);r=e&&e.error&&e.error.message&&e.error.message.value?e.error.message.value:r}catch(e){}sap.m.MessageBox.error(r)}.bind(this)})}.bind(this)})},_getInvKlassConcat:function(e){const t=Array.isArray(e)?e:[];if(t.includes("NONE")){return""}const r=["A","G","I","T"];return r.filter(e=>t.includes(e)).join("")},_splitTdlines:function(e,t){const r=t||132;const n=String(e||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");const s=[];const i=n.split("\n");i.forEach((e,t)=>{const n=String(e||"");if(n.length===0){s.push("");return}for(let e=0;e<n.length;e+=r){s.push(n.substring(e,e+r))}});return s},_buildHeaderTextLines:function(e,t){const r=[];const n=String(e&&e.note||"").trim();if(n){this._splitTdlines(n,132).forEach(e=>{r.push({Tdid:"B01",Tdline:e})})}const s=Number(t.weExpectedIndex)===0;const i=Number(t.AmtsvertragsbezugIndex)===0;const o=String(t.avbNumber||"").trim();if(s&&i&&o){this._splitTdlines(o,132).forEach(e=>{r.push({Tdid:"B03",Tdline:e})})}return r},_buildItemTextLines:function(e){const t=[];const r=String(e.ZmmWebsKatId||"").toUpperCase()==="FREETEXT"||String(e.ZmmWebsArtikelId||"").toUpperCase().startsWith("FREETEXT-");if(!r){return t}const n=String(e.addText||e.AddText||e.Zusatztext||e.zusatztext||e.freitextAddText||"").trim();if(!n){return t}this._splitTdlines(n,132).forEach(e=>{t.push({Tdid:"B01",Tdline:e})});return t},_buildDeepCreatePayload:function(){const e=this._getCartEntries()||[];const t=this.getView().getModel("checkout").getData()||{};const r=t.head||{};const n=Number(r.UmweltIndex);const s=n===0?"X":"";const i=Number(r.materialTypeIndex);const o=i===0?"ZNPR":i===1?"ZIN1":"ZNPR";const a=r.invArt==="NONE"?"":String(r.invArt||"");const c=this._getInvKlassConcat(r.klass);const l=e=>String(e).padStart(2,"0");const u=e=>{if(!(e instanceof Date)||isNaN(e.getTime())){return""}return String(e.getFullYear())+l(e.getMonth()+1)+l(e.getDate())};const d=this._buildHeaderTextLines(t,r);const g=e.map(e=>{const t=e.desiredDate instanceof Date?e.desiredDate:null;const n={Txz01:String(e.ZmmWebsArtBez||e.description||e.Txz01||""),MengeD:String(e.MENGE??""),Meins:String(e.Meins||"ST"),Matkl:String(e.Matkl||""),WerksD:String(r.werks||""),Eeind:t?u(t):"",Idnlf:String(e.Idnlf||"").slice(0,35),Knttp:e.accountType==="gl"?"K":e.accountType==="io"?"F":e.accountType==="wbs"?"P":"",Kostl:String(e.costCenter||""),Wlief:String(e.Wlief||""),Ekgrp:String(e.Ekgrp||""),Sakto:String(e.glAccount||""),Ekorg:String(r.ekorg||""),Bapre:String(e.Bapre??""),Uname:String(e.receiver||"").trim().toUpperCase()};const s=this._buildItemTextLines(e);if(s.length){n.NavTo_PositionTextLine=s}return n});const h={Bsart:o,ZdeBanfInvArtKurz:a,ZdeBanfInvKlass:c,ZdeBanfFlagNachhaltig:s,zzsigma:String(r.sigma||"FG00"),NavTo_BanfItem:g};if(d.length){h.NavTo_TextLine=d}return h},_onStepActivate:function(e){},_applyDesiredDateDefault:function(){const e=this.getView().getModel(h);if(!e){return}const t=this._getCartEntries()||[];if(!t.length){return}const r=new Date;r.setHours(0,0,0,0);const n=24*60*60*1e3;const s=new Date(r.getTime()+7*n);t.forEach(function(t,r){if(!t.desiredDate){e.setProperty("/cartEntries/"+r+"/desiredDate",new Date(s))}});e.refresh(true)},_checkCartRequired:function(){const e=this._getCartEntries()||[];const t=this.getResourceBundle();const r=new Set;if(!e.length){r.add(t.getText("cw.field.emptyCart"));return{ok:false,missing:Array.from(r)}}e.forEach(e=>{if(!e.receiver){r.add(t.getText("cw.field.receiver"))}if(!e.accountType){r.add(t.getText("cw.field.accountType"))}if(e.accountType==="gl"&&!e.costCenter){r.add(t.getText("cw.field.costCenter"))}else if(e.accountType==="io"&&!e.internalOrder){r.add(t.getText("cw.field.internalOrder"))}else if(e.accountType==="wbs"&&!e.accountValue){r.add(t.getText("cw.field.wbs"))}if(!e.Matkl){r.add(t.getText("cw.field.matkl"))}const n=Number(e.weExpectedIndex);if(!Number.isInteger(n)||n<0){r.add(t.getText("cw.field.weExpected"))}if(!e.glAccount){r.add(t.getText("cw.field.glAccount"))}});return{ok:r.size===0,missing:Array.from(r)}},onValueHelpKostl:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();var n=e.getSource();this._oKostlActiveInput=n;if(!this._oKostlJsonModel){this._oKostlJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oKostlJsonModel,"vhKostl")}var s=function(){if(!this._oKostlVH){this._oKostlVH=new sap.m.SelectDialog({title:this.getResourceBundle().getText("cw.vh.kostl.title"),items:{path:"vhKostl>/results",template:new sap.m.StandardListItem({title:"{vhKostl>Kostl}",description:"{vhKostl>Mctxt}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyKostlSearchFilter(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oKostlActiveInput){return}var r=t.getBindingContext("vhKostl").getObject();var n=String(r.Kostl||"").trim();var s=this._oKostlActiveInput;var i=s.getBindingInfo("value");if(i&&i.parts&&i.parts.length){var o=i.parts[0].model;var a=i.parts[0].path;if(a&&a[0]!=="/"){var c=s.getBindingContext(o);if(c){a=c.getPath()+"/"+a}else{a="/"+a}}s.getModel(o).setProperty(a,n)}else{s.setValue(n)}}.bind(this),cancel:function(){}});t.addDependent(this._oKostlVH)}var e=(n.getValue()||"").trim();this._oKostlVH.open(e);this._applyKostlSearchFilter(e)}.bind(this);var i=this._oKostlJsonModel.getProperty("/results")||[];if(i.length>0){s();return}r.read("/KostsSet",{urlParameters:{$select:"Kostl,Mctxt",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__kostl=String(t.Kostl||"").toLowerCase();t.__mctxt=String(t.Mctxt||"").toLowerCase();return t});this._oKostlJsonModel.setProperty("/results",t);s()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("cw.vh.kostl.loadError"));console.log(e)}})},_applyKostlSearchFilter:function(e){if(!this._oKostlVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oKostlVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("__kostl",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__mctxt",sap.ui.model.FilterOperator.Contains,t)],and:false})],"Application")},onValueHelpWbs:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();this._oWbsActiveInput=e.getSource();if(!this._oWbsVH){this._oWbsVH=new s({title:this.getResourceBundle().getText("cw.vh.wbs.title"),items:{path:"/plafPspelSet",template:new i({title:"{Pspel}"})},search:function(e){var t=e.getParameter("value")||"";var r=e.getSource().getBinding("items");if(!r){return}r.filter(t?[new o("Pspel",a.Contains,t)]:[])},confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oWbsActiveInput){return}var r=t.getBindingContext().getProperty("Pspel");var n=this._oWbsActiveInput.getBinding("value");if(n&&n.setValue){n.setValue(r)}else{this._oWbsActiveInput.setValue(r)}}.bind(this),cancel:function(){}});this._oWbsVH.setModel(r);t.addDependent(this._oWbsVH)}var n=this._oWbsActiveInput.getValue()||"";var c=this._oWbsVH.getBinding("items");if(c){c.filter(n?[new o("Pspel",a.Contains,n)]:[])}this._oWbsVH.open(n)},onValueHelpUser:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();var n=e.getSource();this._oUserActiveInput=n;if(!this._oUserJsonModel){this._oUserJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oUserJsonModel,"vhUser")}var s=function(){if(!this._oUserVH){this._oUserVH=new sap.m.SelectDialog({title:this.getResourceBundle().getText("cw.vh.user.title"),items:{path:"vhUser>/results",template:new sap.m.StandardListItem({title:"{vhUser>Bname}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyUserSearchFilter(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oUserActiveInput){return}var r=t.getBindingContext("vhUser").getObject();var n=String(r.Bname||"").trim();var s=this._oUserActiveInput;var i=s.getBindingInfo("value");if(i&&i.parts&&i.parts.length){var o=i.parts[0].model;var a=i.parts[0].path;if(a&&a[0]!=="/"){var c=s.getBindingContext(o);if(c){a=c.getPath()+"/"+a}else{a="/"+a}}s.getModel(o).setProperty(a,n)}else{s.setValue(n)}}.bind(this),cancel:function(){}});t.addDependent(this._oUserVH)}var e=(n.getValue()||"").trim();this._oUserVH.open(e);this._applyUserSearchFilter(e)}.bind(this);var i=this._oUserJsonModel.getProperty("/results")||[];if(i.length>0){s();return}r.read("/UserAddrSet",{urlParameters:{$select:"Bname",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__bname=String(t.Bname||"").toLowerCase();return t});this._oUserJsonModel.setProperty("/results",t);s()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("cw.vh.user.loadError"));console.log(e)}})},_applyUserSearchFilter:function(e){if(!this._oUserVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oUserVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter("__bname",sap.ui.model.FilterOperator.Contains,t)],"Application")},onValueHelpMatkl:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();var n=e.getSource();this._oMatklActiveInput=n;if(!this._oMatklJsonModel){this._oMatklJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oMatklJsonModel,"vhMatkl")}var s=function(){if(!this._oMatklVH){this._oMatklVH=new sap.m.SelectDialog({title:this.getResourceBundle().getText("cw.vh.matkl.title"),items:{path:"vhMatkl>/results",template:new sap.m.StandardListItem({title:"{vhMatkl>Matkl}",description:"{vhMatkl>Wgbez60}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyMatklSearchFilter(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oMatklActiveInput){return}var r=t.getBindingContext("vhMatkl").getObject();var n=String(r.Matkl||"").trim();var s=this._oMatklActiveInput;var i=s.getBindingInfo("value");if(i&&i.parts&&i.parts.length){var o=i.parts[0].model;var a=i.parts[0].path;if(a&&a[0]!=="/"){var c=s.getBindingContext(o);if(c){a=c.getPath()+"/"+a}else{a="/"+a}}s.getModel(o).setProperty(a,n)}else{s.setValue(n)}}.bind(this),cancel:function(){}});t.addDependent(this._oMatklVH)}var e=(n.getValue()||"").trim();this._oMatklVH.open(e);this._applyMatklSearchFilter(e)}.bind(this);var i=this._oMatklJsonModel.getProperty("/results")||[];if(i.length>0){s();return}r.read("/HT023Set",{urlParameters:{$select:"Matkl,Wgbez60",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__matkl=String(t.Matkl||"").toLowerCase();t.__wgbez60=String(t.Wgbez60||"").toLowerCase();return t});this._oMatklJsonModel.setProperty("/results",t);s()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("cw.vh.matkl.loadError"));console.log(e)}})},_applyMatklSearchFilter:function(e){if(!this._oMatklVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oMatklVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("__matkl",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__wgbez60",sap.ui.model.FilterOperator.Contains,t)],and:false})],"Application")},onValueHelpGl:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();var n=e.getSource();this._oGlActiveInput=n;if(!this._oGlJsonModel){this._oGlJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oGlJsonModel,"vhGl")}var s=function(){if(!this._oGlVH){this._oGlVH=new sap.m.SelectDialog({title:this.getResourceBundle().getText("cw.vh.gl.title"),items:{path:"vhGl>/results",template:new sap.m.StandardListItem({title:"{vhGl>Saknr}",description:"{vhGl>Txt50}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyGlSearchFilter(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oGlActiveInput){return}var r=t.getBindingContext("vhGl").getObject();var n=String(r.Saknr||"").trim();var s=this._oGlActiveInput;var i=s.getBindingInfo("value");if(i&&i.parts&&i.parts.length){var o=i.parts[0].model;var a=i.parts[0].path;if(a&&a[0]!=="/"){var c=s.getBindingContext(o);if(c){a=c.getPath()+"/"+a}else{a="/"+a}}s.getModel(o).setProperty(a,n)}else{s.setValue(n)}}.bind(this),cancel:function(){}});t.addDependent(this._oGlVH)}var e=(n.getValue()||"").trim();this._oGlVH.open(e);this._applyGlSearchFilter(e)}.bind(this);var i=this._oGlJsonModel.getProperty("/results")||[];if(i.length>0){s();return}r.read("/SakoCoreSet",{urlParameters:{$select:"Saknr,Txt50",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__saknr=String(t.Saknr||"").toLowerCase();t.__txt50=String(t.Txt50||"").toLowerCase();return t});this._oGlJsonModel.setProperty("/results",t);s()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getResourceBundle().getText("cw.vh.gl.loadError"));console.log(e)}})},_applyGlSearchFilter:function(e){if(!this._oGlVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oGlVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("__saknr",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__txt50",sap.ui.model.FilterOperator.Contains,t)],and:false})],"Application")},_prefillReceiversWithCurrentUser:function(){this._getCurrentSapUserId().then(function(e){if(!e){return}const t=this.getView().getModel("cartProducts");if(!t){return}const r=this._getCartEntries()||[];if(!r.length){return}r.forEach(function(r,n){const s=String(r&&r.receiver||"").trim();if(!s){t.setProperty("/cartEntries/"+n+"/receiver",e)}});t.refresh(true)}.bind(this))},_getCurrentSapUserId:function(){return new Promise(function(e){try{if(sap.ushell&&sap.ushell.Container){if(sap.ushell.Container.getUser){const t=sap.ushell.Container.getUser();const r=t&&t.getId&&t.getId();if(r){e(String(r));return}}if(sap.ushell.Container.getServiceAsync){sap.ushell.Container.getServiceAsync("UserInfo").then(function(t){let r="";if(t&&typeof t.getId==="function"){r=t.getId()}else if(t&&typeof t.getUser==="function"){const e=t.getUser();r=e&&e.getId&&e.getId()}e(r?String(r):"")}).catch(function(){e("")});return}}}catch(e){}e("")})},onWeChange:function(e){var t=Number(e.getParameter("selectedIndex"));var r=e.getSource().getBindingContext("cartProducts");if(r){r.getModel().setProperty(r.getPath()+"/weExpectedIndex",t)}var n=this.getView().getModel("checkout");if(n){n.setProperty("/head/weExpectedIndex",t);if(t===1){n.setProperty("/head/AmtsvertragsbezugIndex",-1);n.setProperty("/head/sigma","");n.setProperty("/head/avbNumber","")}}this._syncHeadWeToCartItems()},onAttachFUChange:function(e){const t=e.getParameter("files")||[];if(!t.length){return}const r=this.getView().getModel("checkout");const n=r.getProperty("/attachments")||[];Array.from(t).forEach(e=>{n.push({id:Date.now()+"_"+Math.random().toString(36).slice(2),fileName:e.name,mediaType:e.type||"",size:e.size||0,objectUrl:URL.createObjectURL(e),_file:e,uploadState:"PENDING",docId:"",error:""})});r.setProperty("/attachments",n);r.refresh(true);const s=e.getSource();if(s&&s.clear){s.clear()}},_getServiceUrl:function(){const e=this.getOwnerComponent().getModel();let t=e&&e.sServiceUrl||"";if(t.endsWith("/")){t=t.slice(0,-1)}return t},_extractDocIdFromUploadResponse:function(e){const t=e.getResponseHeader("location")||e.getResponseHeader("Location")||"";if(t){const e=t.match(/Docid='([^']+)'/i)||t.match(/DocId='([^']+)'/i);if(e&&e[1]){return decodeURIComponent(e[1])}}const r=e.responseText||"";if(r){try{const e=JSON.parse(r);const t=e&&e.d?e.d:e;return t&&(t.DocId||t.Docid||t.docId||t.docid||t.ZMM_WEBS_DOC_ID)?String(t.DocId||t.Docid||t.docId||t.docid||t.ZMM_WEBS_DOC_ID):""}catch(e){}}return""},_uploadSingleAttachment:function(e,t){return new Promise((r,n)=>{const s=this.getResourceBundle();if(!e){n(new Error(s.getText("cw.upload.noFile")));return}if(!t){n(new Error(s.getText("cw.upload.noBanfn")));return}const i=this.getOwnerComponent().getModel();const o=e.name||"upload.bin";const a=String(t)+"|"+encodeURIComponent(o);const c=e.type||"application/octet-stream";const l=this._getServiceUrl()+"/BanfAttachmentSet";const u=new XMLHttpRequest;u.open("POST",l,true);u.setRequestHeader("Content-Type",c);u.setRequestHeader("Slug",a);u.setRequestHeader("Accept","application/json");const d=()=>{if(u.status>=200&&u.status<300){const e=this._extractDocIdFromUploadResponse(u);r({docId:e,raw:u.responseText||""})}else{const e=s.getText("cw.upload.failed",[String(u.status),String(u.responseText||"")]);n(new Error(e))}};u.onload=d;u.onerror=()=>n(new Error(s.getText("cw.upload.networkError")));i.refreshSecurityToken(()=>{try{const e=i.getSecurityToken();if(e){u.setRequestHeader("x-csrf-token",e)}}catch(e){}u.send(e)},()=>{n(new Error(s.getText("cw.upload.csrfError")))})})},_uploadAllAttachmentsForBanfn:async function(e){const t=this.getView().getModel("checkout");const r=t.getProperty("/attachments")||[];for(let n=0;n<r.length;n++){const s=r[n];if(!s||!s._file){continue}t.setProperty("/attachments/"+n+"/uploadState","UPLOADING");t.setProperty("/attachments/"+n+"/error","");t.refresh(true);try{const r=await this._uploadSingleAttachment(s._file,e);t.setProperty("/attachments/"+n+"/uploadState","DONE");t.setProperty("/attachments/"+n+"/docId",r.docId||"")}catch(e){t.setProperty("/attachments/"+n+"/uploadState","ERROR");t.setProperty("/attachments/"+n+"/error",String(e&&e.message?e.message:e));throw e}t.refresh(true)}},onAttachDelete:function(e){const t=e.getParameter("listItem")||e.getParameter("item");const r=t&&t.getBindingContext("checkout");if(!r){return}const n=r.getPath();const s=parseInt(n.split("/").pop(),10);const i=this.getView().getModel("checkout");const o=i.getProperty("/attachments")||[];const a=o[s];try{if(a&&a.objectUrl){URL.revokeObjectURL(a.objectUrl)}}catch(e){}o.splice(s,1);i.setProperty("/attachments",o);i.refresh(true)},onAttachOpen:function(e){const t=e.getSource();const r=t&&t.getBindingContext&&t.getBindingContext("checkout")||e.getParameter("listItem")&&e.getParameter("listItem").getBindingContext("checkout")||e.getParameter("item")&&e.getParameter("item").getBindingContext("checkout");const n=r&&r.getObject();if(n&&n.objectUrl){window.open(n.objectUrl,"_blank")}},onExit:function(){const e=this.getView().getModel("checkout").getProperty("/attachments")||[];e.forEach(e=>{try{URL.revokeObjectURL(e.objectUrl)}catch(e){}})},_validateStepForm:function(){return true},onInvArtChange:function(e){const t=e.getSource();const r=e.getParameter("selectedItem");const n=r?r.getKey():t.getSelectedKey()||"";this.getView().getModel("checkout").setProperty("/head/invArt",n);if(this.getView().getModel("checkoutWizard").getProperty("/validate")){t.setValueState(n?"None":"Error");t.setValueStateText(n?"":this.getResourceBundle().getText("cw.invArt.mandatory"))}},_validateStepAccounting:function(){const e=this.getResourceBundle();const t=this.getView().getModel("checkout");const r=t.getProperty("/head")||{};const n=[];if(!(r.weExpectedIndex===0||r.weExpectedIndex===1)){n.push(e.getText("cw.field.weOrService"))}if(r.weExpectedIndex===0){if(!r.sigma){n.push(e.getText("cw.field.sigma"))}if(!(r.AmtsvertragsbezugIndex===0||r.AmtsvertragsbezugIndex===1)){n.push(e.getText("cw.field.avbRef"))}if(r.AmtsvertragsbezugIndex===0){const t=r.avbNumber||"";if(!t.trim()){n.push(e.getText("cw.field.avbNumber"))}}}if(!(r.materialTypeIndex===0||r.materialTypeIndex===1)){n.push(e.getText("cw.field.orderType"))}if(r.materialTypeIndex===1){const t=this.byId("inpZKostl");const r=t&&t.getValue?t.getValue().trim():"";if(!r){n.push(e.getText("cw.field.costCenter"))}}const s=String(r.invArt||"").trim();if(!s){n.push(e.getText("cw.field.invArt"))}if(r.materialTypeIndex===0){const t=this._getCartEntries()||[];const r=t[0];if(!r){n.push(e.getText("cw.field.accountType"))}else{const t=r.accountType||"";if(!t){n.push(e.getText("cw.field.accountType"))}else if(t==="gl"&&!(r.costCenter||"").trim()){n.push(e.getText("cw.field.costCenter"))}else if(t==="io"&&!(r.internalOrder||"").trim()){n.push(e.getText("cw.field.internalOrder"))}else if(t==="wbs"&&!(r.accountValue||"").trim()){n.push(e.getText("cw.field.wbs"))}}}if(!Array.isArray(r.klass)||r.klass.length===0){n.push(e.getText("cw.field.classification"))}if(!r.werks){n.push(e.getText("cw.field.plant"))}if(!(r.UmweltIndex===0||r.UmweltIndex===1)){n.push(e.getText("cw.field.sustainability"))}if(n.length){sap.m.MessageBox.warning(e.getText("cw.msg.fillRequired")+" \n• "+n.join("\n• "));return false}return true},_createCheckoutDefaults:function(){return{banfn:"",plant:"",costCenter:"",note:"",attachments:[],head:{materialTypeIndex:-1,itRelvIndex:-1,hazardIndex:-1,exportIndex:-1,weExpectedIndex:-1,AmtsvertragsbezugIndex:-1,avbNumber:"",sigma:"",werks:"",ekorg:"",ekgrp:"",klass:[],UmweltIndex:-1,invArtKurz:"",invArt:"",invArtKeys:[]}}},_getCartEntries:function(){const e=this.getView().getModel(h);const t=e&&e.getProperty("/cartEntries");return Array.isArray(t)?t:Object.values(t||{})},_syncHeadWeToCartItems:function(){const e=this.getView().getModel("checkout");const t=this.getView().getModel("cartProducts");if(!e||!t){return}const r=Number(e.getProperty("/head/weExpectedIndex"));if(!(r===0||r===1)){return}const n=this._getCartEntries()||[];n.forEach((e,n)=>{const s=Number(e.weExpectedIndex);if(!(s===0||s===1)){t.setProperty("/cartEntries/"+n+"/weExpectedIndex",r)}});t.refresh(true)},onAccountTypeChange:function(e){const t=e.getSource();const r=t.getSelectedKey();const n=t.getBindingContext("cartProducts");if(!n){return}const s=n.getModel(),i=n.getPath();if(r!=="gl"){s.setProperty(i+"/costCenter","")}if(r!=="io"){s.setProperty(i+"/internalOrder","")}if(r!=="wbs"){s.setProperty(i+"/accountValue","")}},_ensureCartItemExtensions:function(){const e=this.getView().getModel(h);if(!e){return}const t=this._getCartEntries().map(function(e){return Object.assign({},e,{receiver:e.receiver||"",accountType:e.accountType||"",costCenter:e.costCenter||"",internalOrder:e.internalOrder||"",accountValue:e.accountValue||"",Matkl:e.Matkl||"",Wlief:e.Wlief||"",Ekgrp:e.Ekgrp||"",Idnlf:e.Idnlf||"",addText:e.addText||e.freitextAddText||e.AddText||e.Zusatztext||e.zusatztext||"",desiredDate:e.desiredDate||null,glAccount:e.glAccount||"",weExpectedIndex:typeof e.weExpectedIndex==="number"?e.weExpectedIndex:-1})});e.setProperty("/cartEntries",t);e.refresh(true)}})});
//# sourceMappingURL=CheckoutWizard.controller.js.map