sap.ui.define(["./BaseController","../model/formatter","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],(e,t,i,o,n)=>{"use strict";return e.extend("diehlwebshop.controller.Product",{formatter:t,onInit:function(){const e=this.getOwnerComponent();this._router=e.getRouter();this.getView().setModel(new i([]),"productImages");this._pImageGalleryDialog=null;this._oImageGalleryDialog=null;this._router.getRoute("product").attachPatternMatched(this._onRouteMatched,this);this._router.getTarget("product").attachDisplay(function(e){this._bindProductById(e.getParameter("data").productId)},this)},_onRouteMatched:function(e){this._bindProductById(e.getParameter("arguments").productId)},_bindProductById:function(e){const t=this.getView();const i=t.getModel();i.metadataLoaded().then(function(){const o="/"+i.createKey("ArtikelSet",{ZmmWebsArtikelId:e});t.bindElement({path:o,events:{dataRequested:()=>t.setBusy(true),dataReceived:()=>{t.setBusy(false);this._checkIfProductAvailable(o);this._loadProductImages(e)},change:()=>{this._checkIfProductAvailable(o);this._loadProductImages(e)}}})}.bind(this))},_getImageGalleryDialog:function(){const e=this.getView().getId();const t=e+"--imageGalleryDialog";const i=sap.ui.getCore().byId(t);if(i){this._oImageGalleryDialog=i;i.setModel(this.getView().getModel("productImages"),"productImages");i.setModel(this.getOwnerComponent().getModel("i18n"),"i18n");i.setModel(this.getOwnerComponent().getModel("device"),"device");this._pImageGalleryDialog=Promise.resolve(i);return this._pImageGalleryDialog}if(this._pImageGalleryDialog){return this._pImageGalleryDialog}this._pImageGalleryDialog=sap.ui.core.Fragment.load({id:e,name:"diehlwebshop.view.fragments.ImageGalleryDialog",controller:this}).then(function(e){this._oImageGalleryDialog=e;this.getView().addDependent(e);e.setModel(this.getView().getModel("productImages"),"productImages");e.setModel(this.getOwnerComponent().getModel("i18n"),"i18n");e.setModel(this.getOwnerComponent().getModel("device"),"device");return e}.bind(this)).catch(function(e){this._pImageGalleryDialog=null;throw e}.bind(this));return this._pImageGalleryDialog},onProductCarouselPageChanged:function(e){const t=e.getParameter("newActivePageId");const i=t?sap.ui.getCore().byId(t):null;const o=i&&i.getBindingContext("productImages");const n=o&&o.getPath?o.getPath():"";const s=parseInt(String(n).split("/").pop(),10);this._iLastProductCarouselIndex=Number.isInteger(s)?s:0},onOpenImageGallery:async function(e){const t=await this._getImageGalleryDialog();let i=-1;const o=e&&e.getSource?e.getSource():null;const n=o&&o.getBindingContext?o.getBindingContext("productImages"):null;if(n){const e=n.getPath();const t=parseInt(String(e).split("/").pop(),10);if(Number.isInteger(t)){i=t}}if(!Number.isInteger(i)||i<0){const e=this.byId("productCarousel");if(e){const t=e.getActivePage();const o=t&&sap.ui.getCore().byId(t);if(o){i=e.indexOfPage(o)}}}const s=function(){t.detachAfterOpen(s);const e=sap.ui.core.Fragment.byId(this.getView().getId(),"imageGalleryCarousel");if(!e){return}const o=e.getPages();if(!o||!o.length){return}const n=Number.isInteger(i)&&o[i]?i:0;e.setActivePage(o[n].getId());this._applyContainToGalleryImages()}.bind(this);t.attachAfterOpen(s);t.open()},onCloseImageGallery:function(){if(this._oImageGalleryDialog){this._oImageGalleryDialog.close()}},onPrevImage:function(){const e=sap.ui.core.Fragment.byId(this.getView().getId(),"imageGalleryCarousel");if(e){e.previous();this._applyContainToGalleryImages()}},onNextImage:function(){const e=sap.ui.core.Fragment.byId(this.getView().getId(),"imageGalleryCarousel");if(e){e.next();this._applyContainToGalleryImages()}},onExit:function(){if(this._oImageGalleryDialog){this._oImageGalleryDialog.destroy();this._oImageGalleryDialog=null}this._pImageGalleryDialog=null},_applyContainToGalleryImages:function(){if(!this._oImageGalleryDialog){return}const e=this._oImageGalleryDialog.$();if(!e||e.length===0){return}e.find("img").each(function(){this.style.objectFit="contain";this.style.width="100%";this.style.height="100%";this.style.maxWidth="100%";this.style.maxHeight="100%";this.style.display="block"})},_loadProductImages:function(e){const t=this.getView().getModel("productImages");if(!e){t.setData([]);t.updateBindings(true);return}const i=this.getView().getModel();const s=i.getMetaModel();const a=s.getODataEntitySet("ArtiikelbildSet");if(!a){t.setData([]);t.updateBindings(true);return}const r=[new o("ArtikelId",n.EQ,String(e))];i.read("/ArtiikelbildSet",{filters:r,success:function(e){const o=e&&e.results?e.results:[];if(!o.length){t.setData([]);t.updateBindings(true);return}let n=i.sServiceUrl||"";if(n.endsWith("/")){n=n.slice(0,-1)}const s=o.map(function(e){const t=e.ArtikelId;const o=e.DocId;if(!t||!o){return null}const s=i.createKey("BildmediaSet",{ArtikelId:t,DocId:o});const a=n+"/"+s+"/$value";const r=e.ImageOrder??e.ORDER??e.SeqNr??e.SEQNR??e.Sort??e.SORT_NR??0;return{src:a,order:parseInt(r,10)||0,title:e.Filename||e.TITLE||e.ALT||e.BEZEICHNUNG||""}}).filter(Boolean);s.sort((e,t)=>e.order-t.order);t.setData(s);t.updateBindings(true)}.bind(this),error:function(){t.setData([]);t.updateBindings(true)}})},_checkIfProductAvailable:function(e){const t=this.getModel().getProperty(e);if(t==null){this._router.getTargets().display("notFound")}},onToggleCart:function(e){const t=!!e.getParameter("pressed");const i=this.getView().getBindingContext();const o=i&&i.getObject?i.getObject():null;if(!o||!o.ZmmWebsKatId||!o.ZmmWebsArtikelId){return}if(t){this.getRouter().navTo("productCart",{id:o.ZmmWebsKatId,productId:o.ZmmWebsArtikelId},true)}else{this.getRouter().navTo("product",{id:o.ZmmWebsKatId,productId:o.ZmmWebsArtikelId},true)}},onAddToCart:function(){const e=this.getView();const t=e.byId("siQtyProduct")||e.byId("siQtySnapped");const i=parseInt(t&&t.getValue?t.getValue():1,10)||1;const o=e.getBindingContext()&&e.getBindingContext().getObject?e.getBindingContext().getObject():null;this._addToCart(o,i)},onBackToHome:function(){const e=this.getOwnerComponent().getModel("appView");if(e){e.setProperty("/cartOpen",false);e.setProperty("/layout","TwoColumnsMidExpanded")}this.getRouter().navTo("purchaseRequests",{},true)},onAddToWatchlist:function(){const e=this.getView();const t=e.byId("siQtyProduct");const i=parseInt(t&&t.getValue?t.getValue():1,10)||1;const o=e.getBindingContext();if(!o){return}const n=o.getObject();const s=this.getOwnerComponent().getModel("cartProducts");let a=s.getProperty("/savedForLaterEntries")||[];if(!Array.isArray(a)){a=Object.values(a)}const r=String(n.ZmmWebsArtikelId);const l=a.findIndex(e=>String(e.ZmmWebsArtikelId)===r);if(l===-1){const e=Object.assign({},n,{MENGE:i});a.push(e);s.setProperty("/savedForLaterEntries",a);s.refresh(true);sap.m.MessageToast.show(this.getResourceBundle().getText("productAddedToWatchlist",[n.ZmmWebsArtBez]))}else{const e=parseInt(a[l].MENGE,10)||0;a[l].MENGE=e+i;s.setProperty("/savedForLaterEntries",a);s.refresh(true);const t=this.getResourceBundle();sap.m.MessageToast.show(this.getResourceBundle().getText("watchlistQuantityUpdated",[a[l].MENGE,n.ZmmWebsArtBez]))}}})});
//# sourceMappingURL=Product.controller.js.map