sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/ListType","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/type/Float"],function(e,t,r,i,n){"use strict";return e.extend("diehlwebshop.controller.PurchaseRequests",{onInit:function(){console.log("PurchaseRequests onInit",Date.now());var e=this.getOwnerComponent().getRouter();e.getRoute("purchaseRequests").attachPatternMatched(this._onRouteMatched,this);if(e.getRoute("purchaseRequestsCart")){e.getRoute("purchaseRequestsCart").attachPatternMatched(this._onRouteMatched,this)}var t=this.byId("banfSmartTable");var r=this.byId("prFilterBar");t.attachInitialise(function(){var e=t.getTable();if(e&&!this._bBapreFmtAttached){this._bBapreFmtAttached=true;e.attachUpdateFinished(this._applyBapreScale2,this)}this._applyBapreScale2();if(e&&e.setMode){e.setMode("MultiSelect");e.attachSelectionChange(this._onSelectionChanged,this)}var r=e.getBindingInfo("items");if(r&&r.template){r.template.setType(sap.m.ListType.Navigation)}e.attachItemPress(this.onRowPress,this);if(t.attachPersonalisationChanged){t.attachPersonalisationChanged(function(){t.rebindTable(true)})}},this);t.attachBeforeRebindTable(this._onBeforeRebindTable,this);if(r){r.attachFilterChange(function(){r.search()})}},_applyBapreScale2:function(){var e=this.byId("banfSmartTable");if(!e){return}var t=e.getTable();if(!t){return}var r=new n({minFractionDigits:2,maxFractionDigits:2});var i=function(e){if(!e||!e.getBindingInfo){return false}var t=e.getBindingInfo("text");if(!t){return false}if(t.path==="Bapre"){return true}if(Array.isArray(t.parts)&&t.parts.some(function(e){return e&&e.path==="Bapre"})){return true}return false};var a=function(e){if(!e||!e.bindProperty){return false}if(!i(e)){return false}e.bindProperty("text",{path:"Bapre",type:r});return true};var s=-1;var o=t.getBindingInfo("items");var u=o&&o.template;if(u&&u.getCells){var l=u.getCells()||[];for(var p=0;p<l.length;p++){if(i(l[p])){s=p;a(l[p]);break}}}var h=t.getItems?t.getItems():[];for(var c=0;c<h.length;c++){var g=h[c]&&h[c].getCells?h[c].getCells():null;if(!g||!g.length){continue}if(s>=0&&g[s]){a(g[s])}else{for(var d=0;d<g.length;d++){if(a(g[d])){break}}}}},_onRouteMatched:function(){var e=this.getOwnerComponent().getModel("appView");var t=!!(e&&e.getProperty("/skipNextPurchaseRequestsRebind"));if(t&&e){e.setProperty("/skipNextPurchaseRequestsRebind",false);return}var r=this.byId("banfSmartTable");if(!r){return}if(r.rebindTable){r.rebindTable(true)}else{var i=r.getTable&&r.getTable();var n=i&&i.getBinding&&i.getBinding("items");if(n&&n.refresh){n.refresh(true)}}},_onSelectionChanged:function(){var e=this.byId("banfSmartTable").getTable();var t=e&&e.getSelectedItems?e.getSelectedItems().length:0;this.byId("btnReAdd").setEnabled(t>0)},onReAddSelected:function(){var e=this.byId("banfSmartTable").getTable();if(!e||!e.getSelectedContexts){return}var t=e.getSelectedContexts();if(!t.length){return}var r=this.getOwnerComponent().getModel("cartProducts");var i=r.getProperty("/cartEntries")||[];t.forEach(function(e){var t=e.getObject();var r=this._mapPurchaseRequestToCartItem(t);if(!r){return}var n=String(r.ZmmWebsArtikelId||"");var a=i.findIndex(function(e){return String(e.ZmmWebsArtikelId)===n});if(a===-1){i.push(r)}else{i[a].MENGE=(parseInt(i[a].MENGE,10)||0)+(parseInt(r.MENGE,10)||1)}}.bind(this));r.setProperty("/cartEntries",i);r.setProperty("/showProceedButton",i.length>0);r.setProperty("/showEditButton",i.length>0);r.refresh(true);sap.m.MessageToast.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("reAddSuccess",[t.length]));e.removeSelections();this.byId("btnReAdd").setEnabled(false)},_mapPurchaseRequestToCartItem:function(e){if(!e){return null}if(e.ZmmWebsArtikelId){var t=Object.assign({},e);if(!t.MENGE){t.MENGE=1}return t}return{ZmmWebsArtikelId:"BANF-"+String(e.Banfn||"")+"-"+String(e.Bnfpo||""),ZmmWebsKatId:"REORDER",ZmmWebsKatBez:e.Txz01||"",ZmmWebsArtBez:e.Txz01||"",Bapre:Number(e.Bapre||0),Waers:e.Waers||"EUR",Meins:e.Meins||"ST",Wlief:e.Lifnr||"",MENGE:1,STATUS:"A"}},_onBeforeRebindTable:function(e){var t=e.getParameter("bindingParams");if(!t){return}t.parameters=t.parameters||{};t.parameters.operationMode="Client";t.parameters.threshold=5e3;var r=this.byId("prFilterBar");if(!r){return}var i=[];try{i=r.getFilters()||[]}catch(e){i=[]}var n=r.getFilterData&&r.getFilterData(true)?r.getFilterData(true):{};var a="";var s=n.Banfn;if(s&&Array.isArray(s.ranges)&&s.ranges.length){var o=s.ranges[0]||{};a=o.value1||o.low||o.value||""}a=String(a||"").trim();var u=a.indexOf("*")>=0;if(a){a=a.replace(/\*/g,"").trim()}var l=Array.isArray(i)?i.slice():[];if(u&&a){l=l.filter(function(e){return!(e&&e.sPath==="Banfn")});l.push(new sap.ui.model.Filter("Banfn",sap.ui.model.FilterOperator.Contains,a))}var p=function(e,t){var r=this.byId(e);if(!r||!r.getValue){return}var i=String(r.getValue()||"").trim();if(!i){return}i=i.replace(/\*/g,"").trim();if(!i){return}l.push(new sap.ui.model.Filter(t,sap.ui.model.FilterOperator.Contains,i))}.bind(this);p("sfbCurrency","Waers");p("sfbSupplier","Lifnr");p("sfbStatusWe","ZmmWebsStatusWe");t.filters=l},onValueHelpCurrency:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();this._oCurrActiveInput=this.byId("sfbCurrency");if(!this._oCurrJsonModel){this._oCurrJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oCurrJsonModel,"vhCurrPR")}var i=function(){if(!this._oCurrVH){this._oCurrVH=new sap.m.SelectDialog({title:this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.currency.title"),items:{path:"vhCurrPR>/results",template:new sap.m.StandardListItem({title:"{vhCurrPR>Waers}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyCurrencySearchFilterPR(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t){return}var r=t.getBindingContext("vhCurrPR").getObject();var i=String(r.Waers||"").trim();if(this._oCurrActiveInput){this._oCurrActiveInput.setValue(i)}this._triggerPrSearch()}.bind(this),cancel:function(){}});t.addDependent(this._oCurrVH)}var e=(this._oCurrActiveInput.getValue()||"").trim();this._oCurrVH.open(e);this._applyCurrencySearchFilterPR(e)}.bind(this);var n=this._oCurrJsonModel.getProperty("/results")||[];if(n.length>0){i();return}r.read("/IsoCurcSet",{urlParameters:{$select:"Waers",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__waers=String(t.Waers||"").toLowerCase();return t});this._oCurrJsonModel.setProperty("/results",t);i()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.currency.loadError"));console.log(e)}})},_applyCurrencySearchFilterPR:function(e){if(!this._oCurrVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oCurrVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter("__waers",sap.ui.model.FilterOperator.Contains,t)],"Application")},onValueHelpSupplier:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();this._oSuppActiveInput=this.byId("sfbSupplier");if(!this._oSuppJsonModel){this._oSuppJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oSuppJsonModel,"vhSuppPR")}var i=function(){if(!this._oSuppVH){this._oSuppVH=new sap.m.SelectDialog({title:this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.supplier.title"),items:{path:"vhSuppPR>/results",template:new sap.m.StandardListItem({title:"{vhSuppPR>Sortl}",description:"{vhSuppPR>Lifnr}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applySupplierSearchFilterPR(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t){return}var r=t.getBindingContext("vhSuppPR").getObject();var i=String(r.Lifnr||"").trim();if(this._oSuppActiveInput){this._oSuppActiveInput.setValue(i)}this._triggerPrSearch()}.bind(this),cancel:function(){}});t.addDependent(this._oSuppVH)}var e=(this._oSuppActiveInput.getValue()||"").trim();this._oSuppVH.open(e);this._applySupplierSearchFilterPR(e)}.bind(this);var n=this._oSuppJsonModel.getProperty("/results")||[];if(n.length>0){i();return}r.read("/KredaSet",{urlParameters:{$select:"Lifnr,Sortl,Mcod1",$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=Object.assign({},e);t.__lifnr=String(t.Lifnr||"").toLowerCase();t.__sortl=String(t.Sortl||"").toLowerCase();t.__mcod1=String(t.Mcod1||"").toLowerCase();return t});this._oSuppJsonModel.setProperty("/results",t);i()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.supplier.loadError"));console.log(e)}})},_applySupplierSearchFilterPR:function(e){if(!this._oSuppVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oSuppVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("__lifnr",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__sortl",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__mcod1",sap.ui.model.FilterOperator.Contains,t)],and:false})],"Application")},onValueHelpStatusWe:function(e){var t=this.getView();var r=this.getOwnerComponent().getModel();var i=e.getSource();this._oStatusWeActiveInput=i;if(!this._oStatusWeJsonModel){this._oStatusWeJsonModel=new sap.ui.model.json.JSONModel({results:[]});t.setModel(this._oStatusWeJsonModel,"vhStatusWe")}var n=function(){if(!this._oStatusWeVH){this._oStatusWeVH=new sap.m.SelectDialog({title:this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.statusWe.title"),items:{path:"vhStatusWe>/results",template:new sap.m.StandardListItem({title:"{vhStatusWe>code}",description:"{vhStatusWe>text}"})},search:function(e){var t=(e.getParameter("value")||"").trim().toLowerCase();this._applyStatusWeSearchFilter(t)}.bind(this),confirm:function(e){var t=e.getParameter("selectedItem");if(!t||!this._oStatusWeActiveInput){return}var r=t.getBindingContext("vhStatusWe").getObject();var i=String(r.code||"").trim();this._oStatusWeActiveInput.setValue(i)}.bind(this),cancel:function(){}});t.addDependent(this._oStatusWeVH)}var e=(i.getValue()||"").trim();this._oStatusWeVH.open(e);this._applyStatusWeSearchFilter(e)}.bind(this);var a=this._oStatusWeJsonModel.getProperty("/results")||[];if(a.length>0){n();return}this._resolveStatusWeEntitySetPath().then(function(e){r.read(e,{urlParameters:{$top:"5000"},success:function(e){var t=e&&e.results?e.results:[];t=t.map(function(e){var t=e.ZmmDeWebsStatusWe||e.ZmmWebsStatusWe||e.StatusWe||e.STATUS_WE||e.Code||"";var r=e.ZmmDeWebsStatusWeBez||e.ZmmWebsStatusWeBez||e.StatusWeBez||e.STATUS_WE_BEZ||e.Text||"";t=String(t||"").trim();r=String(r||"").trim();var i=Object.assign({},e);i.code=t;i.text=r;i.__code=t.toLowerCase();i.__text=r.toLowerCase();return i});t=t.filter(function(e){return(e.code||"").trim().length>0});this._oStatusWeJsonModel.setProperty("/results",t);n()}.bind(this),error:function(e){sap.m.MessageToast.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.statusWe.loadError"));console.log(e)}})}.bind(this)).catch(function(e){sap.m.MessageToast.show(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("vh.statusWe.entitySetNotFound"));console.log(e)})},_applyStatusWeSearchFilter:function(e){if(!this._oStatusWeVH){return}var t=String(e||"").trim().toLowerCase();var r=this._oStatusWeVH.getBinding("items");if(!r){return}if(!t){r.filter([]);return}r.filter([new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("__code",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("__text",sap.ui.model.FilterOperator.Contains,t)],and:false})],"Application")},_resolveStatusWeEntitySetPath:function(){var e=this.getOwnerComponent().getModel();var t=e&&e.getMetaModel?e.getMetaModel():null;var r=["ZmmWebsShStWeSet","ZmmWebsShStWe","ZmmWebsStatusWeSet","StatusWeSet"];if(!t||!t.loaded){return Promise.resolve("/"+r[0])}return t.loaded().then(function(){var e=t.getODataEntityContainer&&t.getODataEntityContainer();var i=e&&e.entitySet?e.entitySet:[];var n="";r.some(function(e){var t=i.some(function(t){return t&&t.name===e});if(t){n=e}return t});if(n){return"/"+n}return"/"+r[0]})},_triggerPrSearch:function(){var e=this.byId("prFilterBar");if(e&&e.search){e.search()}},onRowPress:function(e){var t=e.getParameter("listItem").getBindingContext().getProperty("Banfn");this.getOwnerComponent().getRouter().navTo("purchaseRequestDetail",{banfn:t})},onCartButtonPress:function(){if(typeof this.toggleCart==="function"){this.toggleCart();return}var e=this.getOwnerComponent().getModel("appView");if(!e){return}var t=!!e.getProperty("/cartOpen");if(t){e.setProperty("/cartOpen",false);var r=e.getProperty("/lastNonCartHash");if(r){sap.ui.core.routing.HashChanger.getInstance().replaceHash(r)}else{this.getOwnerComponent().getRouter().navTo("purchaseRequests",{},true)}}else{var i=sap.ui.core.routing.HashChanger.getInstance().getHash()||"";var n=i==="cart"||i.endsWith("/cart")||i.indexOf("purchaseRequests/cart")===0;if(!n){e.setProperty("/lastNonCartHash",i)}e.setProperty("/cartOpen",true);this.getOwnerComponent().getRouter().navTo("cart",{},false)}}})});
//# sourceMappingURL=PurchaseRequests.controller.js.map